<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>MrCoin Master</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /* New Glassmorphism UI */
    :root {
      --bg-color: #0f0c29; /* Deep purple gradient start */
      --primary-color: rgba(255, 255, 255, 0.05);
      --border-color: rgba(255, 255, 255, 0.1);
      --accent-color: #f7b733;
      --text-color: #ffffff;
      --hint-color: #aaaaaa;
      font-family: 'Poppins', sans-serif;
    }
    body {
      background: linear-gradient(to right, #0f0c29, #302b63, #24243e);
      color: var(--text-color);
      margin: 0;
      padding: 15px 15px 80px 15px;
    }
    .page { display: none; }
    .page.active { display: block; animation: fadeIn 0.5s; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .card {
      background: var(--primary-color);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
    }
    .header { text-align: center; margin-bottom: 20px; }
    .header .balance {
        font-size: 32px;
        font-weight: 700;
        background: -webkit-linear-gradient(45deg, var(--accent-color), #fc4a1a);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    .level-progress {
        background: var(--primary-color);
        border-radius: 10px;
        padding: 5px;
        margin-top: 10px;
    }
    .progress-bar {
        background: linear-gradient(to right, #fc4a1a, var(--accent-color));
        height: 10px;
        width: 0%;
        border-radius: 10px;
        transition: width 0.5s ease-in-out;
    }
    .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: center; }
    .stat-grid i { color: var(--accent-color); margin-right: 5px; }

    .task-list .task-item {
        display: flex; align-items: center; padding: 15px;
        margin-bottom: 10px; background: var(--primary-color);
        border: 1px solid var(--border-color); border-radius: 15px;
    }
    .task-list .task-item .icon { font-size: 24px; margin-right: 15px; color: var(--accent-color); width: 30px; }
    .task-list .task-item .info p { margin: 0; font-weight: 500; }
    .task-list .task-item .info span { font-size: 12px; color: var(--hint-color); }
    .task-list .task-item .claim-btn {
        margin-left: auto; background: var(--accent-color); color: #000;
        border: none; padding: 8px 15px; border-radius: 8px; font-weight: 600; cursor: pointer;
    }
    .task-list .task-item.completed { opacity: 0.5; }
    .task-list .task-item.completed .claim-btn { background: #555; cursor: not-allowed; }

    .bottom-nav {
        position: fixed; bottom: 10px; left: 10px; right: 10px;
        background: var(--primary-color); backdrop-filter: blur(15px);
        display: flex; justify-content: space-around;
        padding: 10px 0; border-radius: 20px;
        border: 1px solid var(--border-color);
    }
    .nav-btn { background: none; border: none; color: var(--hint-color); font-size: 12px; text-align: center; cursor: pointer; }
    .nav-btn i { font-size: 22px; display: block; margin-bottom: 4px; }
    .nav-btn.active { color: var(--accent-color); }

    /* Modal for Rewarded Ad */
    .modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.7); display: none;
        align-items: center; justify-content: center; z-index: 1000;
    }
    .modal-content {
        background: var(--bg-color); padding: 20px; border-radius: 20px;
        width: 80%; text-align: center; border: 1px solid var(--border-color);
    }
    #ad-container { min-height: 50px; margin: 15px 0; }
    .close-btn { background: #555; color: white; border: none; padding: 8px 15px; border-radius: 8px; margin-top: 15px; }
  </style>
</head>
<body>

  <!-- Modal for Rewarded Ad -->
  <div id="ad-modal" class="modal">
    <div class="modal-content">
        <h4>Watch Ad & Earn</h4>
        <p style="color:var(--hint-color); font-size: 14px;">The ad will appear below. Close this window after a few seconds.</p>
        <div id="ad-container"></div>
        <button class="close-btn" onclick="closeAdModal()">Close</button>
    </div>
  </div>

  <!-- Pages -->
  <div id="home-page" class="page active">
    <div class="header">
      <p style="color: var(--hint-color);"><span id="username">...</span>'s Empire</p>
      <div class="balance"><i class="fas fa-coins"></i> <span id="main-coins">0</span></div>
    </div>
    <div class="card">
        <div class="stat-grid">
            <div><i class="fas fa-star"></i> Level: <b id="level">1</b></div>
            <div><i class="fas fa-bolt"></i> Energy: <b id="energy-count">10</b></div>
        </div>
        <div class="level-progress">
            <div id="xp-bar" class="progress-bar"></div>
        </div>
        <p style="text-align:center; font-size: 12px; color: var(--hint-color);">XP: <span id="xp">0</span> / <span id="xp-target">100</span></p>
    </div>
  </div>

  <div id="tasks-page" class="page">
    <div class="card">
      <div class="card-header">Daily Tasks</div>
      <div class="task-list" id="task-list"><p id="task-loader">Loading...</p></div>
    </div>
  </div>

  <div id="game-page" class="page">
     <div class="card" style="text-align:center;">
        <div class="card-header">üíé Crystal Cave Adventure</div>
        <i class="fas fa-gem" style="font-size: 80px; color: #8a2be2; margin: 20px 0;"></i>
        <button onclick="exploreCave()" style="background: linear-gradient(45deg, #8a2be2, #4b0082); color: white; border: none; padding: 15px; width:100%; border-radius:12px; font-weight:600;">Explore (1 Energy)</button>
        <div id="game-result" style="margin-top: 20px; font-weight: 500; min-height: 24px;"></div>
     </div>
  </div>
  
  <div id="wallet-page" class="page">
     <div class="card">
        <div class="card-header">üí∏ Withdraw</div>
        <input type="number" id="amount" placeholder="Amount (min 100)" style="width: 95%; margin: 15px 0; background:var(--bg-color); border:1px solid var(--border-color); padding:12px; color:white; border-radius:12px;">
        <button onclick="requestWithdraw()" style="background: var(--accent-color); color:#000; margin-top:15px; width:100%; padding: 12px; border-radius:12px; border:none; font-weight:600;">Request Withdraw</button>
     </div>
  </div>


  <!-- Bottom Navigation Bar -->
  <div class="bottom-nav">
    <button class="nav-btn active" onclick="showPage('home-page')"><i class="fas fa-home"></i> Home</button>
    <button class="nav-btn" onclick="showPage('tasks-page')"><i class="fas fa-tasks"></i> Tasks</button>
    <button class="nav-btn" onclick="showPage('game-page')"><i class="fas fa-gamepad"></i> Game</button>
    <button class="nav-btn" onclick="showPage('wallet-page')"><i class="fas fa-wallet"></i> Wallet</button>
  </div>
  
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <!-- Social Bar Ad Script -->
  <script type='text/javascript' src='//pl27116575.profitableratecpm.com/fe/bf/32/febf3256881a0941fe9a6905755fc859.js'></script>
  
  <script>
    try {
        const firebaseConfig = {
            // ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡¶†‡¶ø‡¶ï Firebase ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶® ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶™‡ßá‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
            apiKey: "AIzaSy...",
            authDomain: "mr-coin-mastar.firebaseapp.com",
            projectId: "mr-coin-mastar",
            storageBucket: "mr-coin-mastar.appspot.com",
            messagingSenderId: "275029670605",
            appId: "1:275029670605:web:e42bb40e9b26314367c784"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const tg = window.Telegram.WebApp;

        let playerData = {
            level: 1, xp: 0, points: 0, coins: 0, energy: 10,
            lastReset: null, dailyTasks: []
        };
        let userId = null;

        function getTodayDateString() { return new Date().toISOString().split('T')[0]; }

        function generateDailyTasks() {
            return [
                { id: 'login', text: "Daily Check-in", reward: 20, completed: false, icon: "fa-check-circle" },
                { id: 'play', text: "Play the game 3 times", reward: 30, completed: false, icon: "fa-gem", progress: 0, target: 3 },
                { id: 'ad', text: "Watch Ad for a big reward", reward: 50, completed: false, icon: "fa-video", ad: true },
                { id: 'wallet', text: "Visit your wallet", reward: 15, completed: false, icon: "fa-wallet" },
                { id: 'refer', text: "Invite a friend (soon)", reward: 100, completed: true, icon: "fa-user-plus" }
            ];
        }

        function renderTasks() {
            // ... (no changes in this function)
        }
        
        function claimTask(index) {
            // ... (no changes in this function)
        }
        
        function watchAd(index) {
            document.getElementById('ad-modal').style.display = 'flex';
            // Dynamically load banner ad script into the modal
            const adContainer = document.getElementById('ad-container');
            adContainer.innerHTML = ''; // Clear previous ad
            const adScript = document.createElement('script');
            adScript.async = true;
            adScript.dataset.cfasync = false;
            // Banner Ad Script
            adScript.src = '//pl27105920.profitableratecpm.com/9db5b9b75728e725b0490f241552e303/invoke.js';
            const adDiv = document.createElement('div');
            adDiv.id = 'container-9db5b9b75728e725b0490f241552e303';
            adContainer.appendChild(adScript);
            adContainer.appendChild(adDiv);
            
            // This button will be handled by the closeAdModal function
            sessionStorage.setItem('adTaskIndex', index);
        }

        function closeAdModal() {
            document.getElementById('ad-modal').style.display = 'none';
            const adBtn = document.querySelector(`.task-item:nth-child(${parseInt(sessionStorage.getItem('adTaskIndex')) + 1}) .claim-btn`);
            if (!adBtn || adBtn.disabled) return;
            
            let countdown = 10;
            adBtn.disabled = true;
            const interval = setInterval(() => {
                adBtn.textContent = `${countdown}s`;
                countdown--;
                if (countdown < 0) {
                    clearInterval(interval);
                    adBtn.textContent = "Claim";
                    adBtn.onclick = () => claimTask(parseInt(sessionStorage.getItem('adTaskIndex')));
                    adBtn.disabled = false;
                    sessionStorage.removeItem('adTaskIndex');
                }
            }, 1000);
        }

        function exploreCave() {
            // ... (no changes in this function)
        }

        function showPage(pageId) {
            // ... (no changes in this function)
        }



        function updateUI() {
            document.getElementById('main-coins').textContent = playerData.coins;
            document.getElementById('username').textContent = tg.initDataUnsafe.user?.first_name || 'Player';
            document.getElementById('level').textContent = playerData.level;
            document.getElementById('xp').textContent = playerData.xp;
            document.getElementById('energy-count').textContent = playerData.energy;

            const xpTarget = 100 * playerData.level;
            document.getElementById('xp-target').textContent = xpTarget;
            const xpPercentage = (playerData.xp / xpTarget) * 100;
            document.getElementById('xp-bar').style.width = `${xpPercentage}%`;
        }

        function saveData() {
            if (!userId) return;
            db.ref(`players_tg/${userId}`).set(playerData);
        }

        function loadFromFirebase() {
             // ... (no changes in this function)
        }
        
        function requestWithdraw() {
             // ... (no changes in this function)
        }

        function initializeApp() {
            tg.ready();
            tg.expand();
            tg.setHeaderColor(getComputedStyle(document.documentElement).getPropertyValue('--bg-color').trim());
            tg.MainButton.hide();
            if (!tg.initDataUnsafe?.user) { document.body.innerHTML = "<h1>Please open in Telegram.</h1>"; return; }
            userId = String(tg.initDataUnsafe.user.id);
            loadFromFirebase();
        }
        initializeApp();
    } catch (e) {
        document.body.innerHTML = `<h1>A critical error occurred: ${e.message}.</h1>`;
        console.error(e);
    }
  </script>
</body>
</html>
