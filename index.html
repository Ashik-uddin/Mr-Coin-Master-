<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>MrCoin Master</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg-color: #0f0c29; --primary-color: rgba(255, 255, 255, 0.05); --border-color: rgba(255, 255, 255, 0.1);
      --accent-color: #f7b733; --text-color: #ffffff; --hint-color: #aaaaaa; font-family: 'Poppins', sans-serif;
    }
    body { background: linear-gradient(to right, #0f0c29, #302b63, #24243e); color: var(--text-color); margin: 0; padding: 15px 15px 90px 15px; }
    .page { display: none; }
    .page.active { display: block; animation: fadeIn 0.5s; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .card { background: var(--primary-color); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 20px; padding: 20px; margin-bottom: 20px; border: 1px solid var(--border-color); }
    .header { text-align: center; margin-bottom: 20px; }
    .header .balance { font-size: 32px; font-weight: 700; background: -webkit-linear-gradient(45deg, var(--accent-color), #fc4a1a); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .level-progress { background: var(--primary-color); border-radius: 10px; padding: 5px; margin-top: 10px; }
    .progress-bar { background: linear-gradient(to right, #fc4a1a, var(--accent-color)); height: 10px; width: 0%; border-radius: 10px; transition: width 0.5s ease-in-out; }
    .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: center; }
    .stat-grid i { color: var(--accent-color); margin-right: 5px; }
    .task-list .task-item { display: flex; align-items: center; padding: 15px; margin-bottom: 10px; background: var(--primary-color); border: 1px solid var(--border-color); border-radius: 15px; }
    .task-list .task-item .claim-btn { margin-left: auto; background: var(--accent-color); color: #000; border: none; padding: 8px 15px; border-radius: 8px; font-weight: 600; cursor: pointer; }
    .task-list .task-item.completed { opacity: 0.5; }
    .task-list .task-item.completed .claim-btn { background: #555; cursor: not-allowed; }
    .bottom-nav { position: fixed; bottom: 10px; left: 10px; right: 10px; background: rgba(0,0,0,0.3); backdrop-filter: blur(15px); display: flex; justify-content: space-around; padding: 10px 0; border-radius: 20px; border: 1px solid var(--border-color); }
    .nav-btn { background: none; border: none; color: var(--hint-color); font-size: 12px; text-align: center; cursor: pointer; }
    .nav-btn i { font-size: 22px; display: block; margin-bottom: 4px; }
    .nav-btn.active { color: var(--accent-color); }
    .action-button { background: var(--accent-color); color: #000; border: none; padding: 12px; width: 100%; border-radius: 12px; font-weight: 600; font-size: 16px; }
    .game-hub .game-option { text-align: center; cursor: pointer; padding: 20px; border-radius: 15px; background: var(--primary-color); border: 1px solid var(--border-color); }
    
    /* Spin Wheel Styles */
    .wheel-container { position: relative; width: 250px; height: 250px; margin: 20px auto; }
    .wheel { width: 100%; height: 100%; border-radius: 50%; background-image: conic-gradient( #ffc400 0% 16.6%, #ff5722 16.6% 33.3%, #4caf50 33.3% 50%, #2196f3 50% 66.6%, #9c27b0 66.6% 83.3%, #e91e63 83.3% 100% ); transition: transform 4s ease-out; }
    .wheel-pointer { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 20px solid transparent; border-right: 20px solid transparent; border-top: 30px solid white; }
    .wheel-button { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80px; height: 80px; border-radius: 50%; background: white; color: black; font-weight: 700; border: 5px solid #333; }
  </style>
</head>
<body>

  <!-- Pages -->
  <div id="home-page" class="page active">
    <div class="header">
      <p style="color: var(--hint-color);"><span id="username">Player</span>'s Empire</p>
      <div class="balance"><i class="fas fa-coins" style="color:#ffd700;"></i> <span id="main-gold">0</span></div>
    </div>
    <div class="card">
        <div class="stat-grid">
            <div><i class="fas fa-star"></i> Level: <b id="level">1</b></div>
            <div><i class="fas fa-bolt"></i> Energy: <b id="energy-count">0</b></div>
        </div>
        <div class="level-progress">
            <div id="xp-bar" class="progress-bar"></div>
        </div>
        <p style="text-align:center; font-size: 12px; color: var(--hint-color);">XP: <span id="xp">0</span> / <span id="xp-target">100</span></p>
    </div>
    <div class="card">
        <div class="stat-grid">
            <div><i class="fas fa-gem" style="color: #4caf50;"></i> Gems:</div>
            <div><b id="gems-balance">0</b></div>
        </div>
    </div>
  </div>

  <div id="tasks-page" class="page">
    <div class="card" style="text-align:center;">
        <div class="card-header">Daily Spin</div>
        <div class="wheel-container">
            <div id="wheel" class="wheel"></div>
            <div class="wheel-pointer"></div>
            <button id="spin-btn" class="wheel-button" onclick="spinWheel()">SPIN</button>
        </div>
    </div>
    <div class="card">
      <div class="card-header">Daily Tasks</div>
      <div class="task-list" id="task-list"><p id="task-loader">Loading...</p></div>
    </div>
  </div>

  <div id="game-page" class="page">
    <div class="card" id="game-hub">
        <div class="stat-grid game-hub">
            <div class="game-option" onclick="showGame('crystal-cave')"><i class="fas fa-gem" style="color: #8a2be2;"></i><p>Crystal Cave</p></div>
            <div class="game-option" onclick="showGame('tap-tap')"><i class="fas fa-hand-pointer" style="color: #f09819;"></i><p>Tap Tap Mania</p></div>
        </div>
    </div>
    <!-- Game Areas (no changes) -->
  </div>
  
  <div id="wallet-page" class="page">
     <div class="card">
        <div class="card-header">💸 Withdraw Gold</div>
        <input type="number" id="amount" placeholder="Amount (min 10)" style="width: 92%; margin: 15px 0; background:var(--bg-color); border:1px solid var(--border-color); padding:12px; color:white; border-radius:12px;">
        <button onclick="requestWithdraw()" class="action-button">Request Withdraw</button>
     </div>
  </div>

  <div class="bottom-nav">
    <button class="nav-btn active" onclick="showPage('home-page')"><i class="fas fa-home"></i> Home</button>
    <button class="nav-btn" onclick="showPage('tasks-page')"><i class="fas fa-tasks"></i> Tasks</button>
    <button class="nav-btn" onclick="showPage('game-page')"><i class="fas fa-gamepad"></i> Game</button>
    <button class="nav-btn" onclick="showPage('wallet-page')"><i class="fas fa-wallet"></i> Wallet</button>
  </div>
  
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script type='text/javascript' src='//pl27116575.profitableratecpm.com/fe/bf/32/febf3256881a0941fe9a6905755fc859.js'></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
        try {
            const firebaseConfig = {
                // আপনার সঠিক Firebase কনফিগারেশন এখানে পেস্ট করুন
                apiKey: "AIzaSy...",
                authDomain: "mr-coin-mastar.firebaseapp.com",
                projectId: "mr-coin-mastar",
                storageBucket: "mr-coin-mastar.appspot.com",
                messagingSenderId: "275029670605",
                appId: "1:275029670605:web:e42bb40e9b26314367c784"
            };
            firebase.initializeApp(firebaseConfig);
            const db = firebase.database();
            const tg = window.Telegram.WebApp;

            let playerData = { level: 1, xp: 0, gems: 0, gold: 0, energy: 10, lastReset: null, dailyTasks: [], spinUsed: false };
            let userId = null;
            let tapGameInterval = null;
            window.handleTap = () => {};

            // --- Navigation ---
            window.showPage = showPage;
            function showPage(pageId) {
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById(pageId).classList.add('active');
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                document.querySelector(`.nav-btn[onclick="showPage('${pageId}')"]`).classList.add('active');
            }

            // --- Tasks & Rewards ---
            function generateDailyTasks() {
                return [
                    { id: 'login', text: "Daily Check-in", reward: 20, completed: false, icon: "fa-check-circle" },
                    { id: 'play', text: "Play any game 3 times", reward: 30, completed: false, icon: "fa-gem", progress: 0, target: 3 },
                    { id: 'wallet', text: "Visit your wallet", reward: 15, completed: false, icon: "fa-wallet" }
                ];
            }
            function renderTasks() {
                const taskListDiv = document.getElementById('task-list');
                taskListDiv.innerHTML = '';
                if (!playerData.dailyTasks) return;
                playerData.dailyTasks.forEach((task, index) => {
                    const isCompleted = (task.target && task.progress >= task.target) || task.completed;
                    const taskDiv = document.createElement('div');
                    taskDiv.className = `task-item ${isCompleted ? 'completed' : ''}`;
                    taskDiv.innerHTML = `<div class="icon"><i class="fas ${task.icon}"></i></div><div class="info"><p>${task.text} ${task.target ? `(${task.progress}/${task.target})` : ''}</p><span>Reward: ${task.reward} Gems</span></div><button class="claim-btn" onclick="claimTask(${index})" ${isCompleted && !task.completed ? '' : 'disabled'}>${task.completed ? 'Done' : 'Claim'}</button>`;
                    taskListDiv.appendChild(taskDiv);
                });
            }
            window.claimTask = claimTask;
            function claimTask(index) {
                const task = playerData.dailyTasks[index];
                if (!task || task.completed || (task.target && task.progress < task.target)) return;
                playerData.gems += task.reward;
                task.completed = true;
                processRewards();
            }
            
            // --- Spin Wheel ---
            window.spinWheel = spinWheel;
            function spinWheel() {
                if (playerData.spinUsed) {
                    alert("You have already used your daily spin!");
                    return;
                }
                playerData.spinUsed = true;
                const spinBtn = document.getElementById('spin-btn');
                spinBtn.disabled = true;
                
                const wheel = document.getElementById('wheel');
                const segments = [50, 1, 100, 2, 20, 0]; // [Gems, Energy, Gems, Gold, Gems, Nothing]
                const segmentAngle = 360 / segments.length;
                const randomStop = Math.floor(Math.random() * segments.length);
                const rotation = 360 * 5 + (randomStop * segmentAngle); // 5 full spins + stop angle
                
                wheel.style.transform = `rotate(${rotation}deg)`;
                
                setTimeout(() => {
                    const prize = segments[randomStop];
                    if (prize > 0) {
                        if (randomStop === 1 || randomStop === 3) { // Energy or Gold
                            if (randomStop === 1) { playerData.energy += prize; alert(`You won ${prize} Energy!`); }
                            if (randomStop === 3) { playerData.gold += prize; alert(`You won ${prize} Gold!`); }
                        } else { // Gems
                            playerData.gems += prize;
                            alert(`You won ${prize} Gems!`);
                        }
                    } else {
                        alert("Better luck next time!");
                    }
                    processRewards();
                }, 4500);
            }

            // --- Core Logic ---
            function processRewards() {
                playerData.xp += 5;
                const xpTarget = 100 * playerData.level;
                if (playerData.xp >= xpTarget) {
                    playerData.level++;
                    playerData.xp -= xpTarget;
                }
                if (playerData.gems >= 1000) {
                    playerData.gold += Math.floor(playerData.gems / 1000);
                    playerData.gems %= 1000;
                }
                updateUI();
                renderTasks();
                saveData();
            }

            function updateUI() {
                document.getElementById('main-gold').textContent = playerData.gold;
                document.getElementById('username').textContent = tg.initDataUnsafe?.user?.first_name || 'Player';
                document.getElementById('level').textContent = playerData.level;
                document.getElementById('xp').textContent = playerData.xp;
                document.getElementById('energy-count').textContent = playerData.energy;
                document.getElementById('gems-balance').textContent = playerData.gems;
                const xpTarget = 100 * playerData.level;
                document.getElementById('xp-target').textContent = xpTarget;
                document.getElementById('xp-bar').style.width = `${(playerData.xp / xpTarget) * 100}%`;
                document.getElementById('spin-btn').disabled = playerData.spinUsed;
            }

            function saveData() { if (userId) db.ref(`players_tg/${userId}`).set(playerData); }

            function loadFromFirebase() {
                db.ref(`players_tg/${userId}`).once("value").then(snapshot => {
                    const today = getTodayDateString();
                    if (snapshot.exists()) {
                        playerData = { ...playerData, ...snapshot.val() };
                        if (playerData.lastReset !== today) {
                            playerData.dailyTasks = generateDailyTasks();
                            playerData.energy = 10;
                            playerData.lastReset = today;
                            playerData.spinUsed = false;
                        }
                    } else {
                        playerData.dailyTasks = generateDailyTasks();
                        playerData.lastReset = today;
                    }
                    const loginTask = playerData.dailyTasks.find(t => t.id === 'login');
                    if (loginTask && !loginTask.completed) {
                        claimTask(playerData.dailyTasks.indexOf(loginTask));
                    } else {
                        renderTasks();
                    }
                    updateUI();
                    saveData();
                });
            }
            
            function initializeApp() {
                tg.ready();
                tg.expand();
                tg.setHeaderColor(getComputedStyle(document.documentElement).getPropertyValue('--bg-color').trim());
                tg.MainButton.hide();
                if (!tg.initDataUnsafe?.user?.id) {
                    document.body.innerHTML = "<h1>Please open in Telegram.</h1>";
                    return;
                }
                userId = String(tg.initDataUnsafe.user.id);
                loadFromFirebase();
            }
            initializeApp();
        } catch (e) {
            document.body.innerHTML = `<h1>Error: ${e.message}</h1>`;
        }
    });
  </script>
</body>
</html>
