<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>MrCoin Master</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /* ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ü‡¶ó‡ßá‡¶∞ CSS ‡¶ï‡ßã‡¶° ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶•‡¶æ‡¶ï‡¶¨‡ßá */
    :root {
      --bg-color: #121212;
      --primary-color: #1e1e1e;
      --secondary-color: #2a2a2a;
      --accent-color: #ffc400;
      --text-color: #ffffff;
      --hint-color: #aaaaaa;
      font-family: 'Poppins', sans-serif;
    }
    body { background: var(--bg-color); color: var(--text-color); margin: 0; padding: 15px 15px 80px 15px; }
    .page { display: none; }
    .page.active { display: block; animation: fadeIn 0.5s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .header { text-align: center; margin-bottom: 20px; }
    .header .balance { background: linear-gradient(45deg, var(--accent-color), #ffdb58); color: #000; padding: 5px 15px; border-radius: 20px; font-weight: 600; display: inline-block; font-size: 20px; }
    .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
    .stat-card { background: var(--primary-color); padding: 15px; border-radius: 12px; text-align: center; }
    .stat-card span { display: block; font-size: 14px; color: var(--hint-color); }
    .stat-card b { font-size: 22px; }
    .card { background: var(--primary-color); padding: 20px; border-radius: 16px; margin-bottom: 20px; }
    .card-header { font-size: 18px; font-weight: 600; margin-bottom: 15px; }
    .task-list .task-item { display: flex; align-items: center; background: var(--secondary-color); padding: 15px; border-radius: 12px; margin-bottom: 10px; }
    .task-list .task-item .icon { font-size: 24px; margin-right: 15px; color: var(--accent-color); }
    .task-list .task-item .info p { margin: 0; }
    .task-list .task-item .info span { font-size: 12px; color: var(--hint-color); }
    .task-list .task-item .claim-btn { margin-left: auto; background: var(--accent-color); color: #000; border: none; padding: 8px 15px; border-radius: 8px; font-weight: 600; cursor: pointer; min-width: 80px; text-align: center; }
    .task-list .task-item.completed { opacity: 0.6; }
    .task-list .task-item.completed .claim-btn { background: #555; color: #999; cursor: not-allowed; }
    .ad-task { background: linear-gradient(45deg, #0052d4, #4364f7, #6fb1fc); }
    .game-card { text-align: center; }
    .game-card .energy { margin: 15px 0; font-size: 16px; }
    .game-card .explore-btn { background: linear-gradient(45deg, #8a2be2, #4b0082); color: white; border: none; padding: 15px 30px; font-size: 18px; font-weight: 700; border-radius: 12px; cursor: pointer; width: 100%; }
    .game-card #game-result { margin-top: 20px; font-weight: 500; min-height: 24px; }
    .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--primary-color); display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid #333; }
    .nav-btn { background: none; border: none; color: var(--hint-color); font-size: 12px; text-align: center; cursor: pointer; }
    .nav-btn i { font-size: 22px; display: block; margin-bottom: 4px; }
    .nav-btn.active { color: var(--accent-color); }
  </style>
</head>
<body>

  <!-- Pages -->
  <div id="home-page" class="page active">
    <div class="header">
      <p>Your Balance</p>
      <div class="balance"><i class="fas fa-coins"></i> <span id="main-coins">0</span></div>
    </div>
    <div class="stat-grid">
      <div class="stat-card"><span><i class="fas fa-user"></i> Player</span><b id="username">...</b></div>
      <div class="stat-card"><span><i class="fas fa-star"></i> Level</span><b id="level">1</b></div>
    </div>
    <div class="card">
        <div id="ad-container"></div>
    </div>
  </div>

  <div id="tasks-page" class="page">
    <div class="card">
      <div class="card-header">Daily Tasks</div>
      <div class="task-list" id="task-list"><p id="task-loader">Loading...</p></div>
    </div>
  </div>

  <div id="game-page" class="page">
      <div class="stat-card" style="margin-bottom: 20px;"><span><i class="fas fa-bolt"></i> Your Energy</span><b id="energy-count">0</b> / 10</div>
      <div class="card game-card">
        <div class="card-header">üíé Crystal Cave Adventure</div>
        <button class="explore-btn" onclick="exploreCave()">Explore</button>
        <div id="game-result"></div>
      </div>
  </div>

  <div id="wallet-page" class="page">
     <div class="card">
        <div class="card-header">üí∏ Withdraw MrCoins</div>
        <input type="number" id="amount" placeholder="Amount (min 100)" style="width: 95%; margin: 15px 0;">
        <button class="explore-btn" onclick="requestWithdraw()" style="background: var(--accent-color); color:#000; margin-top:15px; width:100%; padding: 10px 20px;">Request Withdraw</button>
     </div>
  </div>

  <div class="bottom-nav">
    <button class="nav-btn active" onclick="showPage('home-page')"><i class="fas fa-home"></i> Home</button>
    <button class="nav-btn" onclick="showPage('tasks-page')"><i class="fas fa-tasks"></i> Tasks</button>
    <button class="nav-btn" onclick="showPage('game-page')"><i class="fas fa-gamepad"></i> Game</button>
    <button class="nav-btn" onclick="showPage('wallet-page')"><i class="fas fa-wallet"></i> Wallet</button>
  </div>
  
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script async="async" data-cfasync="false" src="//pl27105920.profitableratecpm.com/9db5b9b75728e725b0490f241552e303/invoke.js"></script>
  
  <script>
    try {
        const firebaseConfig = {
            // ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡¶†‡¶ø‡¶ï Firebase ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶® ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶™‡ßá‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
            apiKey: "AIzaSy...",
            authDomain: "mr-coin-mastar.firebaseapp.com",
            projectId: "mr-coin-mastar",
            storageBucket: "mr-coin-mastar.appspot.com",
            messagingSenderId: "275029670605",
            appId: "1:275029670605:web:e42bb40e9b26314367c784"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const tg = window.Telegram.WebApp;

        let playerData = {
            level: 1, xp: 0, points: 0, coins: 0, energy: 10,
            lastReset: null, dailyTasks: []
        };
        let userId = null;

        function getTodayDateString() { return new Date().toISOString().split('T')[0]; }

        function generateDailyTasks() {
            return [
                { id: 'login', text: "Daily Check-in", reward: 20, completed: false, icon: "fa-check-circle" },
                { id: 'play', text: "Play the game 3 times", reward: 30, completed: false, icon: "fa-gem", progress: 0, target: 3 },
                { id: 'ad', text: "Watch Ad for a big reward", reward: 50, completed: false, icon: "fa-video", ad: true },
                { id: 'wallet', text: "Visit your wallet", reward: 15, completed: false, icon: "fa-wallet" },
                { id: 'refer', text: "Invite a friend (coming soon)", reward: 100, completed: true, icon: "fa-user-plus" }
            ];
        }

        function renderTasks() {
            const taskListDiv = document.getElementById('task-list');
            const loader = document.getElementById('task-loader');
            if(loader) loader.remove();
            taskListDiv.innerHTML = '';

            playerData.dailyTasks.forEach((task, index) => {
                const isCompleted = task.progress >= task.target || task.completed;
                const taskDiv = document.createElement('div');
                taskDiv.className = `task-item ${isCompleted ? 'completed' : ''} ${task.ad ? 'ad-task' : ''}`;
                
                let buttonHtml = `<button class="claim-btn" onclick="claimTask(${index})" ${isCompleted ? 'disabled' : ''}>${isCompleted ? 'Done' : 'Claim'}</button>`;
                if (task.ad) {
                    buttonHtml = `<button class="claim-btn" id="ad-btn" onclick="watchAd(${index})" ${isCompleted ? 'disabled' : ''}>Watch</button>`;
                }
                
                taskDiv.innerHTML = `
                    <div class="icon"><i class="fas ${task.icon}"></i></div>
                    <div class="info">
                        <p>${task.text} ${task.target ? `(${task.progress}/${task.target})` : ''}</p>
                        <span>Reward: ${task.reward} Points</span>
                    </div>
                    ${buttonHtml}
                `;
                taskListDiv.appendChild(taskDiv);
            });
        }
        
        function claimTask(index) {
            const task = playerData.dailyTasks[index];
            if (!task || task.completed || (task.target && task.progress < task.target)) return;
            
            playerData.points += task.reward;
            task.completed = true;
            updateUI();
            saveData();
            renderTasks();
            tg.HapticFeedback.notificationOccurred('success');
        }
        
        function watchAd(index) {
            const adBtn = document.getElementById('ad-btn');
            if (!adBtn || adBtn.disabled) return;
            
            // Trigger the ad network's pop-under or banner
            // The script loaded in HTML will handle this automatically on user interaction.
            // We simulate a "watching" period.
            let countdown = 15;
            adBtn.disabled = true;
            const interval = setInterval(() => {
                adBtn.textContent = `${countdown}s`;
                countdown--;
                if (countdown < 0) {
                    clearInterval(interval);
                    adBtn.textContent = "Claim";
                    adBtn.onclick = () => claimTask(index);
                    adBtn.disabled = false;
                    tg.HapticFeedback.notificationOccurred('success');
                }
            }, 1000);
        }

        function exploreCave() {
            if (playerData.energy <= 0) { alert("Not enough energy!"); return; }
            playerData.energy--;
            
            const playTask = playerData.dailyTasks.find(t => t.id === 'play');
            if (playTask && !playTask.completed) {
                playTask.progress++;
                if (playTask.progress >= playTask.target) {
                    tg.HapticFeedback.notificationOccurred('success');
                    alert("You've completed the 'Play Game' task! Claim your reward.");
                }
            }
            renderTasks();
            // ... (rest of game logic)
             const resultDiv = document.getElementById('game-result');
            const rand = Math.random();
            let message = "";
            if (rand < 0.02) { message = "üéâ Jackpot! You found a rare MrCoin!"; playerData.coins++; tg.HapticFeedback.impactOccurred('heavy'); }
            else if (rand < 0.2) { const p = Math.floor(Math.random()*30)+20; message = `‚ú® You found ${p} points!`; playerData.points += p; tg.HapticFeedback.impactOccurred('medium'); }
            else if (rand < 0.6) { const p = Math.floor(Math.random()*10)+5; message = `üëç You found ${p} points.`; playerData.points += p; tg.HapticFeedback.impactOccurred('light'); }
            else { message = "üòï The cave was empty... Better luck next time!"; }
            resultDiv.textContent = message;
            
            updateUI();
            saveData();
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.nav-btn[onclick="showPage('${pageId}')"]`).classList.add('active');
            if (pageId === 'wallet-page') {
                const walletTask = playerData.dailyTasks.find(t => t.id === 'wallet');
                if (walletTask && !walletTask.completed) {
                    claimTask(playerData.dailyTasks.indexOf(walletTask));
                }
            }
        }

        function updateUI() {
            document.getElementById('main-coins').textContent = playerData.coins;
            document.getElementById('username').textContent = tg.initDataUnsafe.user?.first_name || 'Player';
            document.getElementById('level').textContent = playerData.level;
            document.getElementById('xp').textContent = playerData.xp;
            document.getElementById('energy-count').textContent = playerData.energy;
        }

        function saveData() {
            if (!userId) return;
            db.ref(`players_tg/${userId}`).set(playerData);
        }

        function loadFromFirebase() {
            db.ref(`players_tg/${userId}`).once("value").then(snapshot => {
                const today = getTodayDateString();
                if (snapshot.exists()) {
                    playerData = { ...playerData, ...snapshot.val() };
                    if (playerData.lastReset !== today) {
                        playerData.dailyTasks = generateDailyTasks();
                        playerData.energy = 10;
                        playerData.lastReset = today;
                    }
                } else {
                    playerData.dailyTasks = generateDailyTasks();
                    playerData.lastReset = today;
                }
                const loginTask = playerData.dailyTasks.find(t => t.id === 'login');
                if (loginTask && !loginTask.completed) {
                    claimTask(playerData.dailyTasks.indexOf(loginTask));
                }
                updateUI();
                renderTasks();
                saveData();
            }).catch(e => {
                console.error("Firebase Read Error:", e);
                document.getElementById('task-list').innerHTML = `<p style="color:red;">Could not load tasks. Please check your connection and Firebase setup.</p>`;
            });
        }
        
        function requestWithdraw() {
             const amount = parseInt(document.getElementById("amount").value.trim());
            if (isNaN(amount) || amount < 100) { alert("Minimum 100 coins required."); return; }
            if (amount > playerData.coins) { alert("Not enough balance."); return; }
            const requestData = { telegramUsername: tg.initDataUnsafe.user?.username || 'N/A', amount, status: 'pending', timestamp: new Date().toISOString() };
            db.ref(`withdraw_requests/${userId}`).push(requestData).then(() => {
                playerData.coins -= amount;
                saveData();
                updateUI();
                document.getElementById("amount").value = "";
                alert("Withdraw request submitted!");
            }).catch(() => alert("Error: Could not submit request."));
        }

        function initializeApp() {
            tg.ready();
            tg.expand();
            tg.setHeaderColor(getComputedStyle(document.documentElement).getPropertyValue('--bg-color').trim());
            tg.MainButton.hide();
            if (!tg.initDataUnsafe?.user) { document.body.innerHTML = "<h1>Please open in Telegram.</h1>"; return; }
            userId = String(tg.initDataUnsafe.user.id);
            loadFromFirebase();
            document.getElementById('ad-container').innerHTML = '<div id="container-9db5b9b75728e725b0490f241552e303"></div>';
        }
        initializeApp();
    } catch (e) {
        document.body.innerHTML = `<h1>A critical error occurred: ${e.message}. Please check console.</h1>`;
        console.error(e);
    }
  </script>
</body>
  </html>
