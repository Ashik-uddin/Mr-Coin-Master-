<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ðŸ’° PointSwap v2.0 - Stable & Complete</title>
    <!-- Dependencies -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color-dark: #131320; --bg-color-light: #1a1a2d; --card-bg: #222235;
            --primary-color: #009cff; --secondary-color: #00e5ff; --text-color: #ffffff;
            --text-muted: #8e9297; --bottom-nav-bg: #1a1a27; --success-color: #28a745;
            --danger-color: #dc3545;
        }

        @keyframes background-pan { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        @keyframes pulse { 0% { box-shadow: 0 0 20px rgba(0, 156, 255, 0.4); } 50% { box-shadow: 0 0 35px rgba(0, 229, 255, 0.7); } 100% { box-shadow: 0 0 20px rgba(0, 156, 255, 0.4); } }
        @keyframes floatUp { to { transform: translateY(-120px); opacity: 0; } }
        @keyframes click-ripple { 0% { transform: scale(1); opacity: 0.5; } 100% { transform: scale(3); opacity: 0; } }

        body {
            background: linear-gradient(135deg, var(--bg-color-dark), var(--bg-color-light), var(--bg-color-dark));
            background-size: 200% 200%;
            animation: background-pan 15s ease infinite;
            color: var(--text-color);
            font-family: 'Poppins', sans-serif;
            overflow: hidden; height: 100dvh; display: flex; flex-direction: column;
        }

        .main-container { flex-grow: 1; display: flex; flex-direction: column; padding: 1rem 1rem 80px 1rem; overflow-y: auto; scrollbar-width: none; -ms-overflow-style: none; }
        .main-container::-webkit-scrollbar { display: none; }
        
        .top-bar { display: flex; justify-content: space-between; gap: 10px; margin-bottom: 20px; }
        .top-bar > div { background: var(--card-bg); border-radius: 12px; padding: 10px; flex-grow: 1; text-align: center; }
        
        .total-balance-container { text-align: center; margin-bottom: 20px; }
        .total-balance { font-size: 3rem; font-weight: 800; color: var(--secondary-color); }
        
        .clicker-section { display: flex; flex-direction: column; align-items: center; justify-content: center; flex-grow: 1; gap: 20px; }
        #clickerBtn {
            width: 250px; height: 250px; border-radius: 50%;
            background: radial-gradient(circle, #00b8ff, #0056b3);
            border: 5px solid #58baff;
            animation: pulse 2s infinite ease-in-out;
            transition: transform 0.1s ease;
            display: flex; justify-content: center; align-items: center; position: relative; overflow: hidden;
        }
        #clickerBtn:active { transform: scale(0.95); animation: none; }
        #clickerBtn img { width: 180px; position: relative; z-index: 2; border-radius: 50%; }
        .click-ripple { position: absolute; border-radius: 50%; background-color: rgba(255, 255, 255, 0.7); animation: click-ripple 0.5s ease-out forwards; z-index: 1; }
        
        .energy-bar-container { width: 80%; max-width: 300px; }
        .energy-bar-container .progress { height: 12px; background-color: var(--card-bg); border-radius: 6px; }
        .energy-bar-container .progress-bar { background: linear-gradient(90deg, var(--secondary-color) 0%, var(--primary-color) 100%); transition: width 0.3s ease; }
        
        .floating-text { position: absolute; font-size: 2.5rem; font-weight: 800; color: white; opacity: 1; animation: floatUp 1.5s ease-out forwards; pointer-events: none; text-shadow: 0 0 10px rgba(0,0,0,0.5); }
        
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background-color: var(--bottom-nav-bg); display: flex; justify-content: space-around; padding: 10px 0; border-top-left-radius: 20px; border-top-right-radius: 20px; box-shadow: 0 -5px 20px rgba(0,0,0,0.3); }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--text-muted); text-decoration: none; font-size: 0.8rem; }
        .nav-item.active { color: var(--primary-color); }
        .nav-item i { font-size: 1.5rem; margin-bottom: 5px; transition: transform 0.2s ease; }
        .nav-item.active i { transform: scale(1.2); }

        .tab-pane { display: none; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .tab-pane.active { display: block; }

        .item-card { display: flex; align-items: center; gap: 15px; background-color: var(--card-bg); padding: 10px; border-radius: 12px; margin-bottom: 10px; cursor: pointer; transition: background-color 0.2s ease; }
        .item-card:hover { background-color: #36364d; }
        .item-card-icon { font-size: 2rem; width: 50px; text-align: center; }
        .item-card-details { flex-grow: 1; }
        .item-card-details strong { font-size: 1.1rem; }
        .item-level-badge { background-color: var(--primary-color); color: var(--bg-color-dark); font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .item-cost { font-weight: bold; }
        .item-progress { height: 4px; background-color: rgba(0,0,0,0.2); border-radius: 2px; margin-top: 5px; }
        .item-progress-bar { height: 100%; background-color: var(--primary-color); border-radius: 2px; transition: width 0.3s ease; }

        #toast-container { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); z-index: 9999; width: 90%; max-width: 400px; }
        .toast-notification { background: #282a36; color: white; padding: 15px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); margin-bottom: 10px; border-left: 5px solid var(--primary-color); }
        .toast-notification.error { border-left-color: var(--danger-color); }
        .toast-notification.success { border-left-color: var(--success-color); }
        
        .spin-container { text-align: center; padding-top: 20px; }
        #wheel-container { position: relative; width: 300px; height: 300px; margin: 20px auto; }
        #spin-wheel { width: 100%; height: 100%; border-radius: 50%; border: 8px solid #fff; background: conic-gradient(#0052D4 0% 12.5%, #4364F7 12.5% 25%, #6FB1FC 25% 37.5%, #009cff 37.5% 50%, #00e5ff 50% 62.5%, #4364F7 62.5% 75%, #0052D4 75% 87.5%, #6FB1FC 87.5% 100%); transition: transform 5s cubic-bezier(0.25, 1, 0.5, 1); }
        #spin-pointer { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 20px solid transparent; border-right: 20px solid transparent; border-top: 30px solid #fff; }
        .spin-segment-text { position: absolute; top: 50%; left: 50%; transform-origin: 0 0; color: white; font-weight: bold; text-shadow: 1px 1px 2px black; font-size: 0.9rem; }
    </style>
</head>
<body>

<div id="app-container" class="main-container">
    
    <!-- Exchange View (Clicker) -->
    <div id="exchange-view" class="tab-pane active" style="display: flex; flex-direction: column; height: 100%;">
        <div class="top-bar">
            <div><small class="text-muted">User</small><div class="fw-bold"><i class="fas fa-user-circle"></i> Ashik Bro</div></div>
            <div><small class="text-muted">Profit/Hour</small><div class="fw-bold"><i class="fas fa-rocket"></i> <span id="profitPerHour">0</span></div></div>
        </div>
        <div class="total-balance-container"><span id="totalBalance" class="total-balance">0</span></div>
        <div class="clicker-section">
            <div id="click-area" style="position: relative;"><button id="clickerBtn"><img src="https://i.ibb.co/3kC73xR/taptap-coin.png" alt="taptap-logo"></button></div>
            <div class="energy-bar-container text-center">
                <span class="fw-bold"><i class="fas fa-bolt text-warning"></i> <span id="energyCount">500</span> / 500</span>
                <div class="progress mt-1"><div id="energyBar" class="progress-bar" role="progressbar"></div></div>
            </div>
        </div>
    </div>
    
    <!-- Mine, Airdrop, Spin Views -->
    <div id="mine-view" class="tab-pane"></div>
    <div id="airdrop-view" class="tab-pane"></div>
    <div id="spin-view" class="tab-pane"></div>

</div>

<!-- Bottom Navigation -->
<nav class="bottom-nav">
    <a href="#" class="nav-item active" data-tab="exchange-view"><i class="fas fa-sync-alt"></i><span>Exchange</span></a>
    <a href="#" class="nav-item" data-tab="mine-view"><i class="fas fa-gavel"></i><span>Mine</span></a>
    <a href="#" class="nav-item" data-tab="spin-view"><i class="fas fa-dharmachakra"></i><span>Spin</span></a>
    <a href="#" class="nav-item" data-tab="airdrop-view"><i class="fas fa-parachute-box"></i><span>Airdrop</span></a>
</nav>

<div id="toast-container"></div>

<script>
// ===================================================================================
//  PointSwap v2.0 - Stable & Complete
// ===================================================================================
const app = {
    config: {
        SAVE_INTERVAL: 5000,
        ENERGY_REGEN_RATE: 2, MAX_ENERGY: 500,
        AD_LOAD_TIMEOUT: 15000,
        DAILY_AD_WATCH_LIMIT: 20, AD_WATCH_REWARD: 1000,
        DAILY_SPIN_LIMIT: 10,
        SPIN_REWARDS: [18, 50, 100, 25, 200, 75, 40, 150],
        DAILY_LOGIN_REWARD: 5000,
        SOCIAL_TASK_REWARD: 2500,
    },
    state: {
        userPoints: 0, energy: 500, profitPerHour: 0,
        upgrades: [
            { id: 'u1', name: 'Trading Bots', icon: 'fa-robot', level: 0, baseCost: 50, profitPerLevel: 10 },
            { id: 'u2', name: 'Liquidity Pools', icon: 'fa-water', level: 0, baseCost: 500, profitPerLevel: 80 },
            { id: 'u3', name: 'DEX Listing', icon: 'fa-chart-line', level: 0, baseCost: 4000, profitPerLevel: 500 },
            { id: 'u4', name: 'Mainnet Launch', icon: 'fa-rocket', level: 0, baseCost: 25000, profitPerLevel: 2500 },
        ],
        pointsPerTap: 1,
        dailyAdsWatched: 0, lastAdWatchDate: '',
        dailySpinsUsed: 0, lastSpinDate: '',
        lastLoginDate: '',
        claimedSocialTasks: { telegram: false, x: false },
        isSpinning: false,
    },

    init() {
        document.addEventListener('DOMContentLoaded', () => {
            this.data.load();
            this.ui.setupEventListeners();
            this.ui.updateAllDisplays();
            
            setInterval(() => this.core.regenerateEnergy(), 1000);
            setInterval(() => this.core.accumulatePassiveIncome(), 1000);
            setInterval(() => this.data.save(), this.config.SAVE_INTERVAL);
        });
    },
    
    ui: {
        animateValue(element, start, end, duration) {
            if (!element) return;
            const targetEnd = Math.floor(end);
            if (start === targetEnd) { element.innerText = targetEnd.toLocaleString(); return; }
            const range = targetEnd - start;
            if(range === 0) return;
            let startTime = null;
            const step = (timestamp) => {
                if (!startTime) startTime = timestamp;
                const progress = Math.min((timestamp - startTime) / duration, 1);
                const currentVal = Math.floor(start + range * progress);
                element.innerText = currentVal.toLocaleString();
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        },
        setupEventListeners() {
            document.getElementById("clickerBtn").addEventListener('click', e => app.core.handleTap(e));
            document.querySelectorAll(".bottom-nav .nav-item").forEach(tab => {
                if(tab.classList.contains("disabled")) return;
                tab.addEventListener("click", e => {
                    e.preventDefault();
                    this.showTab(e.currentTarget.getAttribute("data-tab"));
                });
            });
        },
        showTab(tabId) {
            document.querySelectorAll(".tab-pane").forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.bottom-nav .nav-item').forEach(t => t.classList.remove('active'));
            document.getElementById(tabId)?.classList.add('active');
            document.querySelector(`[data-tab="${tabId}"]`)?.classList.add('active');
            
            if (tabId === 'mine-view') this.renderMine();
            if (tabId === 'airdrop-view') this.airdrop.renderTasks();
            if (tabId === 'spin-view') this.spin.renderSpinUI();
        },
        updateAllDisplays() {
            this.updatePointsDisplay();
            this.updateEnergyDisplay();
            this.updateProfitDisplay();
            const activeTabId = document.querySelector('.tab-pane.active')?.id;
            if(activeTabId) this.showTab(activeTabId);
        },
        updatePointsDisplay() {
            const balanceEl = document.getElementById('totalBalance');
            if(!balanceEl) return;
            const currentDisplayValue = parseInt(balanceEl.innerText.replace(/,/g, '')) || 0;
            const newPointValue = Math.floor(app.state.userPoints);
            if (currentDisplayValue !== newPointValue) {
                this.animateValue(balanceEl, currentDisplayValue, newPointValue, 300);
            }
        },
        updateEnergyDisplay() {
            document.getElementById('energyCount').innerText = `${Math.floor(app.state.energy)} / ${app.config.MAX_ENERGY}`;
            document.getElementById('energyBar').style.width = `${(app.state.energy / app.config.MAX_ENERGY) * 100}%`;
        },
        updateProfitDisplay() {
            document.getElementById('profitPerHour').innerText = `+${app.state.profitPerHour.toLocaleString()}`;
        },
        renderMine() {
            const container = document.getElementById('mine-view');
            container.innerHTML = '<h2 class="text-center mb-4">Mine Upgrades</h2>';
            app.state.upgrades.forEach(upg => {
                const cost = app.core.calculateCost(upg);
                const progress = Math.min((app.state.userPoints / cost) * 100, 100);
                container.innerHTML += `<div class="item-card" onclick="app.core.buyUpgrade('${upg.id}')"><div class="item-card-icon"><i class="fas ${upg.icon}"></i></div><div class="item-card-details"><strong>${upg.name}</strong><small class="text-muted">Profit: +${upg.profitPerLevel.toLocaleString()} PPH</small><div class="item-progress"><div class="item-progress-bar" style="width: ${progress}%"></div></div></div><div class="d-flex flex-column align-items-center"><span class="item-level-badge">Lvl ${upg.level}</span><strong class="item-cost mt-1">${cost.toLocaleString()}</strong></div></div>`;
            });
        },
        showFloatingText(x, y) {
            const text = document.createElement('div');
            text.className = 'floating-text';
            text.innerText = `+${app.state.pointsPerTap}`;
            text.style.left = `${x}px`;
            text.style.top = `${y}px`;
            document.getElementById('click-area').appendChild(text);
            setTimeout(() => text.remove(), 1500);
        },
        showClickRipple(x, y) {
            const clickArea = document.getElementById('clickerBtn');
            const ripple = document.createElement('div');
            ripple.className = 'click-ripple';
            const size = clickArea.offsetWidth;
            ripple.style.width = ripple.style.height = `${size}px`;
            ripple.style.left = `${x - size / 2}px`;
            ripple.style.top = `${y - size / 2}px`;
            clickArea.appendChild(ripple);
            setTimeout(() => ripple.remove(), 500);
        },
        showToast(message, type = 'info') {
             const container = document.getElementById('toast-container');
             if (!container) return;
             const toast = document.createElement('div');
             toast.className = `toast-notification ${type}`;
             const iconClass = type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle';
             toast.innerHTML = `<i class="fas ${iconClass} me-2"></i> ${message}`;
             container.appendChild(toast);
             setTimeout(() => toast.remove(), 3000);
        },
    },

    core: {
        handleTap(e) {
            if (app.state.energy >= app.state.pointsPerTap) {
                app.state.energy -= app.state.pointsPerTap;
                app.state.userPoints += app.state.pointsPerTap;
                app.ui.updatePointsDisplay();
                app.ui.updateEnergyDisplay();
                const rect = e.currentTarget.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                app.ui.showFloatingText(x, y);
                app.ui.showClickRipple(x, y);
                if (window.navigator.vibrate) window.navigator.vibrate(50);
            }
        },
        regenerateEnergy() {
            if (app.state.energy < app.config.MAX_ENERGY) {
                app.state.energy = Math.min(app.config.MAX_ENERGY, app.state.energy + app.config.ENERGY_REGEN_RATE);
                app.ui.updateEnergyDisplay();
            }
        },
        accumulatePassiveIncome() {
            const incomePerSecond = app.state.profitPerHour / 3600;
            if (incomePerSecond > 0) {
                 const oldValue = app.state.userPoints;
                 app.state.userPoints += incomePerSecond;
                 app.ui.animateValue(document.getElementById('totalBalance'), oldValue, app.state.userPoints, 1000);
            }
        },
        calculateCost(upgrade) { return Math.floor(upgrade.baseCost * Math.pow(1.2, upgrade.level)); },
        calculateProfitPerHour() {
            app.state.profitPerHour = app.state.upgrades.reduce((total, upg) => total + (upg.level * upg.profitPerLevel), 0);
            app.ui.updateProfitDisplay();
        },
        buyUpgrade(upgId) {
            const upg = app.state.upgrades.find(u => u.id === upgId);
            const cost = this.calculateCost(upg);
            if (app.state.userPoints >= cost) {
                app.state.userPoints -= cost;
                upg.level++;
                this.calculateProfitPerHour();
                app.ui.updateAllDisplays();
                app.data.save();
            } else {
                app.ui.showToast("Not enough points!", "error");
            }
        },
        showMonetagAd() {
            return new Promise((resolve, reject) => {
                if (typeof show_s === 'undefined') return reject(new Error('Ad library not loaded.'));
                const timeoutId = setTimeout(() => reject(new Error('Ad timed out')), app.config.AD_LOAD_TIMEOUT);
                show_s().then(res => { clearTimeout(timeoutId); resolve(res); }).catch(err => { clearTimeout(timeoutId); reject(err); });
            });
        },
    },
    
    airdrop: {
        renderTasks() {
            const container = document.getElementById('airdrop-view');
            container.innerHTML = `<h2 class="text-center mb-4">Airdrop Tasks</h2>
                ${this.renderDailyLoginTask()}
                ${this.renderDailyAdTask()}
                ${this.renderSocialTask('telegram', 'Join TG Channel', 'fab fa-telegram')}
                ${this.renderSocialTask('x', 'Follow on X', 'fab fa-twitter')}`;
        },
        renderDailyLoginTask() {
            const isCompleted = app.state.lastLoginDate === new Date().toISOString().slice(0, 10);
            return `<div class="item-card"><div class="item-card-icon"><i class="fas fa-calendar-check"></i></div><div class="item-card-details"><strong>Daily Login Bonus</strong><small class="text-muted">Reward: ${app.config.DAILY_LOGIN_REWARD.toLocaleString()} Pts</small></div><button class="btn btn-sm btn-primary" onclick="app.airdrop.claimDailyLogin()" ${isCompleted ? 'disabled' : ''}>${isCompleted ? 'Claimed' : 'Claim'}</button></div>`;
        },
        claimDailyLogin() {
            app.state.userPoints += app.config.DAILY_LOGIN_REWARD;
            app.state.lastLoginDate = new Date().toISOString().slice(0, 10);
            app.ui.showToast(`Daily bonus claimed! +${app.config.DAILY_LOGIN_REWARD.toLocaleString()} Pts`, "success");
            app.ui.updateAllDisplays(); app.data.save();
        },
        renderDailyAdTask() {
            const remaining = app.config.DAILY_AD_WATCH_LIMIT - app.state.dailyAdsWatched;
            const isCompleted = remaining <= 0;
            return `<div class="item-card"><div class="item-card-icon"><i class="fas fa-video"></i></div><div class="item-card-details"><strong>Daily Ad Views</strong><small class="text-muted">Reward: ${app.config.AD_WATCH_REWARD.toLocaleString()} Pts</small><div class="item-progress"><div class="item-progress-bar" style="width:${(app.state.dailyAdsWatched/app.config.DAILY_AD_WATCH_LIMIT)*100}%"></div></div></div><button class="btn btn-sm btn-primary" onclick="app.airdrop.watchDailyAd(event)" ${isCompleted ? 'disabled' : ''}>${isCompleted ? 'Completed' : `Watch (${remaining})`}</button></div>`;
        },
        watchDailyAd(event) {
            if (app.state.dailyAdsWatched >= app.config.DAILY_AD_WATCH_LIMIT) return app.ui.showToast("All daily ads watched.", "error");
            const watchBtn = event.target;
            watchBtn.disabled = true; watchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            app.core.showMonetagAd().then(() => {
                app.state.userPoints += app.config.AD_WATCH_REWARD; app.state.dailyAdsWatched++;
                app.ui.showToast(`+${app.config.AD_WATCH_REWARD.toLocaleString()} points!`, "success");
                this.renderTasks();
                app.ui.updatePointsDisplay();
                app.data.save();
            }).catch(err => app.ui.showToast("Ad failed. Try again.", "error")).finally(() => { watchBtn.disabled = false; this.renderTasks(); });
        },
        renderSocialTask(id, text, icon) {
            const isClaimed = app.state.claimedSocialTasks[id];
            return `<div class="item-card"><div class="item-card-icon"><i class="${icon}"></i></div><div class="item-card-details"><strong>${text}</strong><small class="text-muted">Reward: ${app.config.SOCIAL_TASK_REWARD.toLocaleString()} Pts</small></div><button class="btn btn-sm btn-primary" onclick="app.airdrop.claimSocialTask('${id}')" ${isClaimed ? 'disabled' : ''}>${isClaimed ? 'Claimed' : 'Claim'}</button></div>`;
        },
        claimSocialTask(id) {
            app.state.claimedSocialTasks[id] = true;
            app.state.userPoints += app.config.SOCIAL_TASK_REWARD;
            app.ui.showToast(`Task complete! +${app.config.SOCIAL_TASK_REWARD.toLocaleString()} Pts`, "success");
            this.renderTasks(); app.ui.updatePointsDisplay(); app.data.save();
        }
    },
    
    spin: {
        renderWheelSegments() {
            const wheel = document.getElementById('spin-wheel');
            if(!wheel) return; wheel.innerHTML = '';
            const rewards = app.config.SPIN_REWARDS; const segmentAngle = 360 / rewards.length;
            rewards.forEach((reward, i) => {
                const text = document.createElement('div');
                text.className = 'spin-segment-text'; text.innerText = reward.toLocaleString();
                const angle = (segmentAngle * i) + (segmentAngle / 2);
                text.style.transform = `rotate(${angle}deg) translate(80px) rotate(-${angle}deg)`;
                wheel.appendChild(text);
            });
        },
        renderSpinUI() {
            const container = document.getElementById('spin-view');
            if(!container) return;
            const spinsLeft = app.config.DAILY_SPIN_LIMIT - app.state.dailySpinsUsed;
            container.innerHTML = `<div class="spin-container"><h2><i class="fas fa-dharmachakra"></i> Daily Spin</h2><p class="text-muted">Watch an ad to spin the wheel for a surprise reward!</p><p>Spins left today: <strong id="spinsLeft">${spinsLeft}</strong></p><div id="wheel-container"><div id="spin-wheel"></div><div id="spin-pointer"></div></div><button id="spinBtn" class="btn btn-primary btn-lg mt-3" onclick="app.spin.attemptSpin()"><i class="fas fa-play"></i> Watch Ad & Spin</button></div>`;
            document.getElementById('spinBtn').disabled = (spinsLeft <= 0 || app.state.isSpinning);
            this.renderWheelSegments();
        },
        attemptSpin() {
            if (app.state.isSpinning || app.state.dailySpinsUsed >= app.config.DAILY_SPIN_LIMIT) return;
            const spinBtn = document.getElementById('spinBtn');
            spinBtn.disabled = true; spinBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading Ad...';
            app.core.showMonetagAd().then(() => this._doSpin()).catch(err => {
                app.ui.showToast("Ad failed. Cannot spin.", "error");
                spinBtn.disabled = false; spinBtn.innerHTML = '<i class="fas fa-play"></i> Watch Ad & Spin';
            });
        },
        _doSpin() {
            app.state.isSpinning = true; this.renderSpinUI();
            const wheel = document.getElementById('spin-wheel');
            const rewards = app.config.SPIN_REWARDS; const segmentAngle = 360 / rewards.length;
            const randomIndex = Math.floor(Math.random() * rewards.length); const prize = rewards[randomIndex];
            const randomOffset = (Math.random() - 0.5) * segmentAngle * 0.8;
            const targetAngle = 360 - (randomIndex * segmentAngle + randomOffset);
            wheel.style.transform = `rotate(${targetAngle + 360 * 5}deg)`;
            setTimeout(() => {
                app.state.userPoints += prize; app.state.dailySpinsUsed++; app.state.isSpinning = false;
                app.ui.showToast(`You won ${prize.toLocaleString()} points!`, "success");
                app.ui.updateAllDisplays(); app.data.save();
            }, 5500);
        }
    },
    
    data: {
        save() {
            const dataToSave = {
                userPoints: app.state.userPoints, energy: app.state.energy,
                upgrades: app.state.upgrades.map(u => ({ id: u.id, level: u.level })),
                dailyAdsWatched: app.state.dailyAdsWatched, lastAdWatchDate: app.state.lastAdWatchDate,
                dailySpinsUsed: app.state.dailySpinsUsed, lastSpinDate: app.state.lastSpinDate,
                lastLoginDate: app.state.lastLoginDate, claimedSocialTasks: app.state.claimedSocialTasks,
            };
            localStorage.setItem('pointSwapData', JSON.stringify(dataToSave));
        },
        load() {
            const saved = JSON.parse(localStorage.getItem('pointSwapData'));
            if (!saved) { this.resetDailyTasks(); return; }
            const today = new Date().toISOString().slice(0, 10);
            app.state.userPoints = saved.userPoints || 0;
            app.state.energy = saved.energy !== undefined ? saved.energy : app.config.MAX_ENERGY;
            
            if (saved.lastAdWatchDate === today) app.state.dailyAdsWatched = saved.dailyAdsWatched || 0;
            else app.state.dailyAdsWatched = 0;
            app.state.lastAdWatchDate = today;

            if (saved.lastSpinDate === today) app.state.dailySpinsUsed = saved.dailySpinsUsed || 0;
            else app.state.dailySpinsUsed = 0;
            app.state.lastSpinDate = today;
            
            app.state.lastLoginDate = saved.lastLoginDate || '';
            app.state.claimedSocialTasks = saved.claimedSocialTasks || { telegram: false, x: false };
            if (saved.upgrades) saved.upgrades.forEach(su => { const u = app.state.upgrades.find(upg => upg.id === su.id); if (u) u.level = su.level; });
            app.core.calculateProfitPerHour();
        },
        resetDailyTasks(){
            const today = new Date().toISOString().slice(0, 10);
            app.state.lastAdWatchDate = today;
            app.state.lastSpinDate = today;
        }
    }
};

app.init();
</script>
<script src='//libtl.com/sdk.js' data-zone='9563904' data-sdk='show_s' async></script>
</body>
</html>
